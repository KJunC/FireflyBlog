---
import { Icon } from "astro-icon/components";
import WidgetLayout from "@/components/common/WidgetLayout.astro";
import { siteConfig } from "@/config";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import {
	getCategoryList,
	getSortedPosts,
	getTagList,
} from "@/utils/content-utils";

interface Props {
	class?: string;
	style?: string;
}

const { class: className, style } = Astro.props;

// 从配置中获取站点开始日期
const siteStartDate = siteConfig.siteStartDate || "2025-01-01";

// 获取所有文章
const posts = await getSortedPosts();
const categories = await getCategoryList();
const tags = await getTagList();

// 计算总字数
let totalWords = 0;
for (const post of posts) {
	if (post.body) {
		// 移除代码块和内联代码后计算字数
		let text = post.body
			.replace(/```[\s\S]*?```/g, "") // 移除代码块
			.replace(/`[^`]*`/g, "") // 移除内联代码
			.replace(/\s+/g, " ") // 合并空白
			.trim();

		// 分别计算中文字符和英文字符
		const chineseChars = text.match(/[\u4e00-\u9fa5]/g) || [];
		const englishChars = text.match(/[a-zA-Z]/g) || [];

		totalWords += chineseChars.length + englishChars.length;
	}
}

// 格式化数字（添加千位分隔符）
function formatNumber(num: number): string {
	return num.toLocaleString();
}

// 获取最新文章日期（用于客户端计算）
const latestPost = posts.reduce((latest, post) => {
	if (!latest) return post;
	return post.data.published > latest.data.published ? post : latest;
}, posts[0]);

const lastPostDate = latestPost
	? latestPost.data.published.toISOString()
	: null;

const todayText = i18n(I18nKey.today);

const stats = [
	{
		icon: "material-symbols:article-outline",
		label: i18n(I18nKey.siteStatsPostCount),
		value: posts.length,
	},
	{
		icon: "material-symbols:folder-outline",
		label: i18n(I18nKey.siteStatsCategoryCount),
		value: categories.length,
	},
	{
		icon: "material-symbols:label-outline",
		label: i18n(I18nKey.siteStatsTagCount),
		value: tags.length,
	},
	{
		icon: "material-symbols:text-ad-outline-rounded",
		label: i18n(I18nKey.siteStatsTotalWords),
		value: totalWords,
		formatted: true,
	},
    // --- 新增：不蒜子 访问量 (PV) ---
    {
        icon: "material-symbols:visibility-outline", // 眼睛图标
        label: i18n(I18nKey.siteStatsVisitCount), // 访问量
        value: "...", // 加载时的占位符
        nativeId: "busuanzi_value_site_pv" // 不蒜子要求的特定 ID
    },
    // --- 新增：不蒜子 访客数 (UV) ---
    {
        icon: "material-symbols:person-outline", // 人像图标
        label: i18n(I18nKey.siteStatsPersonCount), // 访客数
        value: "...", 
        nativeId: "busuanzi_value_site_uv" // 不蒜子要求的特定 ID
    },
	{
		icon: "material-symbols:calendar-clock-outline",
		label: i18n(I18nKey.siteStatsRunningDays),
		value: 0, // 将由客户端更新
		suffix: i18n(I18nKey.siteStatsDays).replace("{days}", ""),
		dynamic: true,
		id: "running-days",
	},
	{
		icon: "material-symbols:ecg-heart-outline",
		label: i18n(I18nKey.siteStatsLastUpdate),
		value: 0, // 将由客户端更新
		suffix: i18n(I18nKey.siteStatsDaysAgo).replace("{days}", ""),
		dynamic: true,
		id: "last-update",
	},
];
---

<WidgetLayout name={i18n(I18nKey.siteStats)} id="site-stats" class={className} style={style}>
  <div class="flex flex-col gap-2">
    {stats.map((stat) => (
      <div class="flex items-center justify-between px-3 py-1.5">
        <div class="flex items-center gap-2.5">
          <div class="text-(--primary) text-xl">
            <Icon name={stat.icon} />
          </div>
          <span class="text-neutral-700 dark:text-neutral-300 font-medium text-sm">
            {stat.label}
          </span>
        </div>
        <div class="flex items-center">
          {/* 修改点：添加了 id={stat.nativeId} 以支持不蒜子 */}
          <span 
            class="text-base font-bold text-neutral-900 dark:text-neutral-100"
            data-stat-id={stat.id}
            data-busuanzi-id={stat.nativeId}
          >
            {stat.formatted && typeof stat.value === 'number' ? formatNumber(stat.value) : stat.value}
          </span>
          {stat.suffix && (
            <span class="text-sm text-neutral-500 dark:text-neutral-400 ml-1">
              {stat.suffix}
            </span>
          )}
        </div>
      </div>
    ))}
  </div>
</WidgetLayout>

<script is:inline>
  // 检查是否已经加载过不蒜子，防止因为组件多次渲染导致重复加载（例如移动端和桌面端侧边栏共存时）
  if (!document.querySelector('script[src*="busuanzi.pure.mini.js"]')) {
      const script = document.createElement('script');
      script.src = "//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js";
      script.async = true;
      document.head.appendChild(script);
  }

  // 不蒜子数据同步脚本
  // 解决移动端和桌面端组件共存时，ID重复导致其中一个无法显示数据的问题
  {
      const busuanziIds = ["busuanzi_value_site_pv", "busuanzi_value_site_uv"];
      
      const syncBusuanzi = () => {
          busuanziIds.forEach(id => {
              // 1. 创建或获取隐藏的“真身”元素，供不蒜子脚本写入数据
              let master = document.getElementById(id);
              if (!master) {
                  master = document.createElement('span');
                  master.id = id;
                  master.style.display = 'none';
                  document.body.appendChild(master);
              }

              const update = () => {
                  const value = master.textContent;
                  if (value && value.trim().length > 0) {
                      document.querySelectorAll(`[data-busuanzi-id="${id}"]`).forEach(el => {
                          el.textContent = value;
                      });
                  }
              };

              // 立即同步一次（处理页面切换后数据已存在的情况）
              update();

              // 2. 监听“真身”元素的变化，只绑定一次
              if (!master.hasAttribute('data-observed')) {
                  const observer = new MutationObserver(update);
                  observer.observe(master, { childList: true, characterData: true, subtree: true });
                  master.setAttribute('data-observed', 'true');
              }
          });
      };

      syncBusuanzi();
  }
</script>

<script is:inline define:vars={{ siteStartDate, lastPostDate, todayText }}>
  function updateDynamicStats() {
    const today = new Date();

    // 更新运行天数
    const startDate = new Date(siteStartDate);
    const diffTime = Math.abs(today.getTime() - startDate.getTime());
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

    const runningDaysElements = document.querySelectorAll('[data-stat-id="running-days"]');
    runningDaysElements.forEach((element) => {
      element.textContent = diffDays.toString();
    });

    // 更新最后活动时间
    if (lastPostDate) {
      const lastPost = new Date(lastPostDate);
      const timeSinceLastPost = Math.abs(today.getTime() - lastPost.getTime());
      const daysSinceLastUpdate = Math.floor(timeSinceLastPost / (1000 * 60 * 60 * 24));

      const lastUpdateElements = document.querySelectorAll('[data-stat-id="last-update"]');
      lastUpdateElements.forEach((element) => {
        if (daysSinceLastUpdate === 0) {
          element.textContent = todayText;
          if (element.nextElementSibling) {
            element.nextElementSibling.style.display = 'none';
          }
        } else {
          element.textContent = daysSinceLastUpdate.toString();
          if (element.nextElementSibling) {
            element.nextElementSibling.style.display = '';
          }
        }
      });
    }
  }

  // 页面加载时更新
  updateDynamicStats();

  // 页面切换时重新更新 (Swup 兼容)
  document.addEventListener("swup:contentReplaced", () => {
    setTimeout(updateDynamicStats, 100);
    // 注意：不蒜子在 SPA/Swup 切换时可能不会自动刷新。
    // 如果发现切换页面数字不显示，可以在这里重新加载不蒜子脚本，或者依靠重新渲染组件来触发。
  });
</script>
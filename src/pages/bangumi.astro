---
import { Icon } from "astro-icon/components";
import BangumiSection from "@/components/pages/bangumi/BangumiSection.astro";
import TabNav from "@/components/pages/bangumi/TabNav.astro";
import { siteConfig } from "@/config";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import MainGridLayout from "@/layouts/MainGridLayout.astro";
import type {
	UserSubjectCollection,
	UserSubjectCollectionResponse,
} from "@/types/bangumi";
import { formatDateI18nWithTime } from "@/utils/date-utils";

//å‚è€ƒï¼šéœè‘‰ https://kasuha.com/posts/fuwari-enhance-ep2/

// æ£€æŸ¥é¡µé¢æ˜¯å¦å¯ç”¨
if (!siteConfig.pages.bangumi) {
	return Astro.redirect("/404/");
}

// è·å–æ„å»ºæ—¶é—´
const buildTime = formatDateI18nWithTime(new Date());

////////////// Bangumi é…ç½® ////////////////////////
const bangumiConfig = {
	username: siteConfig.bangumi?.userId, // åœ¨è¿™é‡Œé…ç½®ä½ çš„Bangumiç”¨æˆ·å
	apiUrl: "https://api.bgm.tv",
	categories: {
		book: false,
		anime: false,
		music: false,
		game: false,
		real: false,
	},
	// æ•°æ®è·å–è®¾ç½®
	pagination: {
		limit: 50, // æ¯é¡µè·å–æ•°é‡
		delay: 50, // è¯·æ±‚é—´éš”æ¯«ç§’æ•°ï¼Œé¿å…é¢‘ç‡é™åˆ¶
		maxTotal: 1000, // æœ€å¤§è·å–æ€»æ•°ï¼Œé˜²æ­¢æ— é™å¾ªç¯ï¼ˆ0=æ— é™åˆ¶ï¼‰
	},
};
//////////////////////////////////////////////////

// Steam é…ç½® (æ–°å¢)
const steamConfig = {
	// è¯·åœ¨è¿™é‡Œå¡«å…¥ä½ çš„ Steam ID (64ä½æ•°å­—) å’Œ API Key
	steamId: "76561198069034299", // ä¾‹: "76561198000000000" (åœ¨ https://store.steampowered.com/account/ æŸ¥çœ‹)
	apiKey: "D01F4BF09D9F7FA25B8FAF7EFBEC6A2B",  // ä¾‹: "XXXXXXXXXXXXXXXX" (åœ¨ https://steamcommunity.com/dev/apikey å…è´¹ç”³è¯·)
};

// èµ·ç‚¹/æ‰‹åŠ¨ä¹¦å•é…ç½® (æ–°å¢)
const manualBooks = [
	// ç¤ºä¾‹æ•°æ® (ä½ å¯ä»¥å¤åˆ¶ä¸€ä»½ä¿®æ”¹ï¼Œä¸éœ€è¦çš„å¯ä»¥åˆ æ‰)
	{
		id: 1044312679, // éšä¾¿å¡«ä¸ªæ•°å­—ï¼Œä¸é‡å¤å°±è¡Œ
		title: "ç¬¬å››å¤©ç¾ä»ä¸ç›¸ä¿¡é’¢é“æ´ªæµï¼",
		type: 3, // 1:æƒ³çœ‹, 2:è¯»è¿‡, 3:åœ¨è¯»
		url: "https://www.qidian.com/book/1044312679/",
		cover: "https://bookcover.yuewen.com/qdbimg/349573/1044312679/600.webp", // å°é¢å›¾ç‰‡é“¾æ¥
		score: 8, // ä½ çš„è¯„åˆ†
		comment: "å¾ˆæœ‰æ„æ€", // ç®€çŸ­è¯„ä»·
		author: "å–€ç§‹èç¬¬ä¸€å¯çˆ±"
	},
	{
		id: 1037951424, // éšä¾¿å¡«ä¸ªæ•°å­—ï¼Œä¸é‡å¤å°±è¡Œ
		title: "ä¸œäº¬é“å£«å¼‚é—»å½•",
		type: 2, // 2 ä»£è¡¨è¯»è¿‡
		url: "https://www.qidian.com/book/1037951424/",
		cover: "https://bookcover.yuewen.com/qdbimg/349573/1037951424/600.webp", // å°é¢å›¾ç‰‡é“¾æ¥
		score: 9, // ä½ çš„è¯„åˆ†
		comment: "ä¸œäº¬é¬¼æ€ªä¸‡äº‹å±‹", // ç®€çŸ­è¯„ä»·
		author: "åºšæ˜Ÿå—"
	},
	{
		id: 1042715250, // éšä¾¿å¡«ä¸ªæ•°å­—ï¼Œä¸é‡å¤å°±è¡Œ
		title: "ç©¿ç”²å¼¹ä¸ç›¸ä¿¡ç¢³åŸºæ€ªç‰©",
		url: "https://www.qidian.com/book/1042715250/",
		cover: "https://bookcover.yuewen.com/qdbimg/349573/1042715250/600.webp", // å°é¢å›¾ç‰‡é“¾æ¥
		score: 9, // ä½ çš„è¯„åˆ†
		comment: "æ¨¡å¼å†›äº‹å»ºè®¾", // ç®€çŸ­è¯„ä»·
		author: "å˜Ÿå˜Ÿé›ªçƒæ¥å•¦"
	},
	// åœ¨è¿™é‡Œç»§ç»­æ·»åŠ æ›´å¤šä¹¦...
];

// åˆ†ç±»æ˜ å°„
const categoryMap = {
	book: { id: "book", name: i18n(I18nKey.bangumiCategoryBook), subjectType: 1 },
	anime: {
		id: "anime",
		name: i18n(I18nKey.bangumiCategoryAnime),
		subjectType: 2,
	},
	music: {
		id: "music",
		name: i18n(I18nKey.bangumiCategoryMusic),
		subjectType: 3,
	},
	game: { id: "game", name: i18n(I18nKey.bangumiCategoryGame), subjectType: 4 },
	real: { id: "real", name: i18n(I18nKey.bangumiCategoryReal), subjectType: 6 },
};

// è·å–Bangumiæ•°æ®çš„å‡½æ•° - æ”¯æŒåˆ†é¡µè·å–æ‰€æœ‰æ•°æ®
async function fetchBangumiData(username: string, subjectType: number) {
	try {
		const { limit, delay, maxTotal } = bangumiConfig.pagination;
		let offset = 0;
		let allData: UserSubjectCollection[] = [];
		let hasMore = true;

		// å¼€å‘æ¨¡å¼ä¸‹åªè·å–ä¸€é¡µæ•°æ®ï¼ŒåŠ å¿«è°ƒè¯•é€Ÿåº¦
		const isDev = import.meta.env.DEV;
		const maxPages = isDev ? 1 : 0; // 0 è¡¨ç¤ºä¸é™åˆ¶

		console.log(
			`[Bangumi] ${isDev ? "ğŸ”§ å¼€å‘æ¨¡å¼" : "ğŸŒ ç”Ÿäº§æ¨¡å¼"} - å¼€å§‹è·å–ç”¨æˆ· ${username} çš„ subjectType ${subjectType} æ•°æ®...`,
		);

		while (hasMore) {
			// å¼€å‘æ¨¡å¼é™åˆ¶ï¼šåªè·å–ä¸€é¡µ
			if (isDev && maxPages > 0 && allData.length >= limit * maxPages) {
				console.log(`[Bangumi] å¼€å‘æ¨¡å¼ï¼šå·²è·å– ${maxPages} é¡µæ•°æ®ï¼Œåœæ­¢è·å–`);
				break;
			}

			// æ£€æŸ¥æ˜¯å¦è¶…è¿‡æœ€å¤§è·å–é™åˆ¶
			if (maxTotal > 0 && allData.length >= maxTotal) {
				console.log(`[Bangumi] å·²è¾¾åˆ°æœ€å¤§è·å–é™åˆ¶ ${maxTotal}ï¼Œåœæ­¢è·å–`);
				break;
			}

			const url = `${bangumiConfig.apiUrl}/v0/users/${username}/collections?subject_type=${subjectType}&limit=${limit}&offset=${offset}`;

			console.log(`[Bangumi] æ­£åœ¨è·å–æ•°æ®: ${url} (å·²è·å–: ${allData.length})`);

			const response = await fetch(url, {
				headers: {
					"User-Agent": "YuuOuRou Blog",
					Accept: "application/json",
				},
			});

			if (!response.ok) {
				console.warn(
					`[Bangumi] æ— æ³•è·å–æ•°æ® (çŠ¶æ€ç : ${response.status}):`,
					url,
				);
				break;
			}

			const data = (await response.json()) as UserSubjectCollectionResponse;
			const currentBatch = data.data || [];

			if (currentBatch.length > 0) {
				allData = allData.concat(currentBatch);
				offset += limit;

				// å¦‚æœæœ¬æ¬¡è·å–çš„æ•°æ®å°‘äºlimitï¼Œè¯´æ˜å·²ç»æ˜¯æœ€åä¸€é¡µ
				if (currentBatch.length < limit) {
					hasMore = false;
				}
			} else {
				hasMore = false;
			}

			// æ·»åŠ å»¶è¿Ÿé¿å…è¯·æ±‚è¿‡äºé¢‘ç¹
			if (hasMore) {
				await new Promise((resolve) => setTimeout(resolve, delay));
			}
		}

		console.log(`[Bangumi] æ€»å…±è·å–åˆ° ${allData.length} æ¡æ•°æ®`);
		return allData;
	} catch (error) {
		console.error("[Bangumi] è·å–æ•°æ®æ—¶å‡ºé”™:", error);
		return [];
	}
}

// è·å– Steam æ•°æ®
async function fetchSteamData() {
	if (!steamConfig.steamId || !steamConfig.apiKey) return [];
	try {
		console.log("[Steam] å¼€å§‹è·å– Steam æ¸¸æˆæ•°æ®...");
		const url = `https://api.steampowered.com/IPlayerService/GetOwnedGames/v0001/?key=${steamConfig.apiKey}&steamid=${steamConfig.steamId}&format=json&include_appinfo=1&include_played_free_games=1`;
		const response = await fetch(url);
		const data = await response.json();
		
		if (!data.response || !data.response.games) {
			console.warn("[Steam] æœªè·å–åˆ°æ¸¸æˆæ•°æ®");
			return [];
		}

		// æŒ‰æ¸¸ç©æ—¶é—´æ’åº (ä»å¤šåˆ°å°‘)
		const games = data.response.games.sort((a: any, b: any) => b.playtime_forever - a.playtime_forever);

		return games.map((game: any) => ({
			subject_id: game.appid,
			subject_type: 4,
			type: 2, // 2 ä»£è¡¨ "ç©è¿‡/çœ‹è¿‡" (Collect)
			rate: 0,
			comment: `æ€»æ—¶é•¿: ${(game.playtime_forever / 60).toFixed(1)} å°æ—¶`,
			tags: [],
			subject: {
				id: game.appid,
				type: 4,
				url: `https://store.steampowered.com/app/${game.appid}/`,
				name: game.name,
				name_cn: game.name,
				images: {
					large: `https://cdn.cloudflare.steamstatic.com/steam/apps/${game.appid}/library_600x900.jpg`, // ç«–ç‰ˆå°é¢
					common: `https://cdn.cloudflare.steamstatic.com/steam/apps/${game.appid}/header.jpg`, // æ¨ªç‰ˆå°é¢
					medium: `https://cdn.cloudflare.steamstatic.com/steam/apps/${game.appid}/header.jpg`,
					small: `https://cdn.cloudflare.steamstatic.com/steam/apps/${game.appid}/header.jpg`,
					grid: `https://cdn.cloudflare.steamstatic.com/steam/apps/${game.appid}/header.jpg`,
				},
				date: "",
				score: 0
			}
		}));
	} catch (error) {
		console.error("[Steam] è·å–æ•°æ®å¤±è´¥:", error);
		return [];
	}
}

// è·å–æ‰€æœ‰å¯ç”¨åˆ†ç±»çš„æ•°æ®
const bangumiData: Record<string, UserSubjectCollection[]> = {};
const tabs: Array<{ id: string; name: string; count: number }> = [];

// æ£€æŸ¥æ˜¯å¦å·²é…ç½® Bangumi ç”¨æˆ·ID
const isUserIdConfigured =
	bangumiConfig.username &&
	bangumiConfig.username !== "you-user-id" &&
	bangumiConfig.username.trim() !== "";

if (!isUserIdConfigured) {
	console.log("[Bangumi] âš ï¸ æœªé…ç½® Bangumi ç”¨æˆ·IDï¼Œè·³è¿‡æ•°æ®è·å–");
} else {
	console.log("[Bangumi] ğŸŒ ä» API è·å–æ•°æ®");
}

for (const [categoryKey, enabled] of Object.entries(bangumiConfig.categories)) {
	// å¦‚æœæœªé…ç½®ç”¨æˆ·IDï¼Œè·³è¿‡æ•°æ®è·å–
	if (!isUserIdConfigured) {
		break;
	}
	if (enabled && categoryMap[categoryKey as keyof typeof categoryMap]) {
		const categoryInfo = categoryMap[categoryKey as keyof typeof categoryMap];
		try {
			const data = await fetchBangumiData(
				// biome-ignore lint/style/noNonNullAssertion: Checked by isUserIdConfigured
				bangumiConfig.username!,
				categoryInfo.subjectType,
			);
			bangumiData[categoryKey] = data;
			tabs.push({
				id: categoryKey,
				name: categoryInfo.name,
				count: data.length,
			});
		} catch (error) {
			console.error(`[Bangumi] è·å– ${categoryInfo.name} æ•°æ®å¤±è´¥:`, error);
			bangumiData[categoryKey] = [];
			tabs.push({
				id: categoryKey,
				name: categoryInfo.name,
				count: 0,
			});
		}
	}
}

// è·å–å¹¶æ·»åŠ  Steam æ•°æ®
if (steamConfig.steamId && steamConfig.apiKey) {
	const steamGames = await fetchSteamData();
	if (steamGames.length > 0) {
		bangumiData["steam"] = steamGames;
		tabs.push({
			id: "steam",
			name: "Steam æ¸¸æˆåº“",
			count: steamGames.length,
		});
	}
}

// å¤„ç†æ‰‹åŠ¨ä¹¦å•æ•°æ®
if (manualBooks.length > 0) {
	const bookData = manualBooks.map((book) => ({
		subject_id: book.id,
		subject_type: 1,
		type: book.type || 3, // ä¼˜å…ˆä½¿ç”¨ä¹¦å•é‡Œçš„è®¾ç½®ï¼Œé»˜è®¤ "åœ¨è¯»"
		rate: book.score,
		comment: book.comment,
		tags: [book.author],
		subject: {
			id: book.id,
			type: 1,
			url: book.url,
			name: book.title,
			name_cn: book.title,
			images: {
				large: book.cover,
				common: book.cover,
				medium: book.cover,
				small: book.cover,
				grid: book.cover,
			},
			date: "",
			score: book.score,
		},
	}));
	bangumiData["manual_books"] = bookData;
	tabs.push({
		id: "manual_books",
		name: "èµ·ç‚¹ä¹¦æ¶", // è¿™é‡Œè®¾ç½®æ˜¾ç¤ºçš„æ ‡ç­¾é¡µåç§°
		count: bookData.length,
	});
}

const activeTab = tabs[0]?.id || "anime";
---

<MainGridLayout title={i18n(I18nKey.bangumi)} description={i18n(I18nKey.bangumiSubtitle)}>
  <div class="flex w-full rounded-(--radius-large) overflow-hidden relative min-h-32">
    <div class="card-base z-10 px-9 py-6 relative w-full">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="relative w-full mb-8">
            <div class="mb-6">
                <div class="flex items-center gap-3 mb-3">
                    <div class="h-8 w-8 rounded-lg bg-(--primary) flex items-center justify-center text-white dark:text-black/70">
                        <Icon name="material-symbols:movie" class="text-[1.5rem]"></Icon>
                    </div>
                    <h1 class="text-3xl font-bold text-neutral-900 dark:text-neutral-100">
                        {i18n(I18nKey.bangumi)}
                    </h1>
                </div>
                <p class="text-base text-neutral-600 dark:text-neutral-400 leading-relaxed">
                    {i18n(I18nKey.bangumiSubtitle)}
                </p>
                <p class="text-xs text-neutral-500 dark:text-neutral-500 mt-2">
                    {i18n(I18nKey.bangumiLastUpdated)} {buildTime}
                </p>
            </div>

      <!-- Tab å¯¼èˆªå’Œå†…å®¹ -->
      {tabs.length > 0 ? (
        <>
          <TabNav tabs={tabs} activeTab={activeTab} />

          <!-- å†…å®¹åŒºåŸŸ -->
          {tabs.map((tab) => (
                      <BangumiSection
            sectionId={tab.id}
            items={bangumiData[tab.id] || []}
            isActive={tab.id === activeTab}
            itemsPerPage={6}
          />
          ))}
        </>
      ) : (
        <div class="text-center py-16">
          <div class="inline-flex items-center justify-center w-16 h-16 bg-(--btn-regular-bg) rounded-full mb-6 border border-(--line-divider)">
            <Icon name="material-symbols:settings" class="text-[2rem] text-(--btn-content)" />
          </div>
          <h2 class="text-xl font-semibold text-black/80 dark:text-white/80 mb-3">
            {(isUserIdConfigured || (steamConfig.steamId && steamConfig.apiKey) || manualBooks.length > 0) ? i18n(I18nKey.bangumiEmpty) : "æœªé…ç½®æ•°æ®æº"}
          </h2>
          <p class="text-black/60 dark:text-white/60 mb-4 max-w-md mx-auto">
            è¯·åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½® Bangumi ID æˆ–åœ¨ bangumi.astro ä¸­è®¾ç½® Steam API Key
          </p>
        </div>
      )}
    </div>
  </div>
</MainGridLayout>

<style>
  /* è‡ªå®šä¹‰æ ·å¼ */
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>